---
title: "P8105 Homework 6"
author: "Stephanie Izard"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

##Problem 1

###Reading and manipulating the dataframe:

* Created variable "city_state" to include both city and state
* Created binary variable "resolved" to indicate whether the homicide is solved or unsolved
* Omitted cities Dallas, TX; Phoenix, AZ; and Kansas City, MO because these locations donâ€™t report victim race
* Omitted Tulsa, AL because this is a data entry mistake
* Modified variable "victim_race" to have categories white and non-white, with white as the reference category
* Made sure the variable "victim_age" was numeric

```{r}
homicide_data <- read_csv("./data/homicide-data.csv", na = c("", "NA", "Unknown")) %>%
  janitor::clean_names() %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_race = case_when(
      victim_race == "Asian" ~ "non-white",
      victim_race == "Black" ~ "non-white",
      victim_race == "Hispanic" ~ "non-white",
      victim_race == "Other" ~ "non-white",
      victim_race == "White" ~ "white")) %>% 
  mutate(
    resolved = as.numeric(disposition == "Closed by arrest"),
    victim_age = as.numeric(victim_age),
    victim_race = fct_relevel(victim_race, "white")
  ) %>% 
  filter(city_state != "Dallas, TX", 
         city_state != "Phoenix, AZ", 
         city_state != "Kansas City, MO", 
         city_state != "Tulsa, AL") %>% 
  select(-victim_first, -victim_last)
```

###Fitting a logistic regression model to Baltimore, MD:
* Outcome: resolved vs unresolved (case_status)
* Predictors: victim age (victim_age), sex (victim_sex), and race (victim_race)

```{r}
baltimore_df <- homicide_data %>% 
  filter(city_state == "Baltimore, MD")

baltimore_fit <- baltimore_df %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

baltimore_fit %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         ci_lower = exp(estimate - 1.96*std.error),
         ci_upper = exp(estimate + 1.96*std.error)) %>% 
  filter(term == "victim_racenon-white") %>% 
  select(term, OR, ci_lower, ci_upper) %>% 
  knitr::kable(digits = 3)
```

###Fitting a logistic regression model for all cities:

```{r}
homicide_data_glm <- homicide_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
  mutate(OR = exp(estimate),
         ci_lower = exp(estimate - 1.96*std.error),
         ci_upper = exp(estimate + 1.96*std.error)) %>% 
  filter(term == "victim_racenon-white") %>% 
  select(city_state, OR, ci_lower, ci_upper) 

homicide_data_glm %>% 
  knitr::kable(digits = 3)
```

###Plotting estimated ORs and CIs for each city:

* Organized according to OR

```{r}
homicide_data_glm %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  group_by(city_state) %>%
  ggplot(aes(x = city_state, y = OR)) +
    geom_point(color = "darkslateblue") +
    geom_errorbar(aes(ymax = ci_lower, ymin = ci_upper)) +
    labs(x = "City",
         y = "Odds",
         title = "Odds by city",
         caption = "Error bars represent the 95% confidence interval") +
    coord_flip() +
    theme_minimal()
```

Comments: Tampa, FL has the highest odds

##Problem 2

####Loading and cleaning the data:

* List variables changed here

```{r}
bw_df <- read_csv("./data/birthweight.csv") %>% 
  janitor::clean_names()

glimpse(bw_df)

```

The hypothesized model will be based of a hypothesized structure for the factors that underly birthweight.

* Outcome: birthweight
* Main exposure: length
* Covariates: gestational age in weeks (gest_age), mother's weight gain during preganncy (wt_gain)




